<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artisan Marketplace</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <style>
        /* BASE STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #faf9f7;
            min-height: 100vh;
            color: #333333;
        }

        /* NAVIGATION */
        .nav {
            background: #fff;
            padding: 1.2rem 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 300;
            color: #333333;
            letter-spacing: 2px;
            text-transform: lowercase;
        }

        .cart-button {
            position: relative;
            background: transparent;
            color: #333333;
            border: 1px solid #333333;
            padding: 0.6rem 1.5rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .cart-button:hover {
            background: #333333;
            color: #ffffff;
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #333333;
            color: #ffffff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* HERO SECTION */
        .hero {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #f5f3ef 0%, #e8e5df 100%);
            padding: 8rem 3rem 7rem;
            text-align: center;
        }

        .hero-lottie {
            position: absolute;
            inset: 0;
            z-index: 1;
            opacity: 0.25;
            pointer-events: none;
            will-change: transform;
        }

        .hero-lottie lottie-player {
            width: 100%;
            height: 100%;
        }

        .hero-content {
            position: relative;
            z-index: 2;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 300;
            margin-bottom: 0.8rem;
            color: #333333;
            letter-spacing: 1px;
        }

        .hero p {
            font-size: 1.2rem;
            color: #888888;
            font-weight: 300;
        }

        /* PRODUCT GRID */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 4rem 3rem;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .product-card {
            background: #ffffff;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        .product-image-wrapper {
            position: relative;
            overflow: hidden;
            background: #f5f1eb;
        }

        .product-image {
            width: 100%;
            height: 320px;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .product-info {
            padding: 1.8rem;
            text-align: center;
        }

        .product-name {
            font-size: 1rem;
            font-weight: 400;
            color: #333333;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
        }

        .product-price {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .add-to-cart-btn {
            width: 100%;
            background: transparent;
            border: 1px solid #333333;
            padding: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-to-cart-btn:hover:not(:disabled) {
            background: #333333;
            color: #ffffff;
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal-content {
            background: #ffffff;
            max-width: 600px;
            margin: 3rem auto;
            padding: 3rem;
            position: relative;
        }

        input {
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0;
            border: 1px solid #dddddd;
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            width: 100%;
            background: #333333;
            color: #ffffff;
            border: none;
            padding: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-secondary {
            width: 100%;
            background: transparent;
            border: 1px solid #333333;
            padding: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            text-transform: uppercase;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid #eee;
        }

        /* ORDER SUCCESS SCREEN STYLES */
        .success-container {
            text-align: center;
            padding: 1rem 0;
        }

        .success-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 1.5rem;
            border: 2px solid #2ecc71;
            color: #2ecc71;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .success-title {
            font-size: 1.4rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            line-height: 1.4;
        }

        .payment-box {
            background: #7d1b58; /* Matching the pinkish tone in your screenshot */
            color: white;
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 8px;
        }

        .payment-box p {
            font-size: 1.1rem;
            font-weight: 300;
        }

        @media (max-width: 768px) {
            .nav-content { padding: 0 1.5rem; }
            .hero h1 { font-size: 2.2rem; }
            .container { padding: 3rem 1.5rem; }
            .modal-content { padding: 2rem 1.5rem; }
        }
    </style>
</head>
<body>

    <nav class="nav">
        <div class="nav-content">
            <div class="logo" id="businessName">schön</div>
            <button class="cart-button" onclick="showCart()">
                <span>Cart</span>
                <span class="cart-badge" id="cartBadge">0</span>
            </button>
        </div>
    </nav>

    <div class="hero">
        <div class="hero-lottie">
            <lottie-player src="bg.json" background="transparent" speed="1" loop autoplay preserveAspectRatio="xMidYMid slice"></lottie-player>
        </div>
        <div class="hero-content">
            <h1 id="heroTitle">Handcrafted with Love</h1>
            <p id="heroSubtitle">Discover unique artisan creations</p>
        </div>
    </div>

    <div class="container">
        <div class="products-grid" id="productsGrid"></div>
    </div>

    <div id="cartModal" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, push, set, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAfxtCHxeDz-RQR9vIk2FIORQLKtQ58uC8",
            authDomain: "by-artholic.firebaseapp.com",
            databaseURL: "https://by-artholic-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "by-artholic",
            storageBucket: "by-artholic.firebasestorage.app",
            messagingSenderId: "1082906393096",
            appId: "1:1082906393096:web:d5a7ab883fc432e624afbd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        let products = {};

        // Listen for Site Settings
        onValue(ref(db, 'settings'), s => {
            const d = s.val() || {};
            document.getElementById('businessName').innerText = d.name || 'schön';
            document.getElementById('heroTitle').innerText = d.title || 'Handcrafted with Love';
            document.getElementById('heroSubtitle').innerText = d.subtitle || 'Discover unique artisan creations';
        });

        // Listen for Products
        onValue(ref(db, 'products'), s => {
            const data = s.val();
            products = data || {};
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            for (let id in products) {
                const p = products[id];
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-image-wrapper">
                        <img src="${p.image || 'https://via.placeholder.com/400'}" alt="${p.name}" class="product-image">
                    </div>
                    <div class="product-info">
                        <div class="product-name">${p.name}</div>
                        <div class="product-price">$${p.price.toFixed(2)}</div>
                        <button class="add-to-cart-btn" onclick="addToCart('${id}')" ${p.stock <= 0 ? 'disabled' : ''}>
                            ${p.stock > 0 ? 'Add to Cart' : 'Sold Out'}
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            }
        });

        // CART LOGIC
        window.addToCart = (id) => {
            const product = products[id];
            if (!product) return;
            const existing = cart.find(i => i.id === id);
            if (existing) {
                if (existing.qty < product.stock) existing.qty++;
                else { alert('Max stock reached'); return; }
            } else {
                cart.push({ id, name: product.name, price: product.price, qty: 1, max: product.stock });
            }
            updateCartUI();
        };

        window.updateCartUI = () => {
            localStorage.setItem('cart', JSON.stringify(cart));
            const badge = document.getElementById('cartBadge');
            const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
            badge.textContent = totalItems;
            badge.style.display = totalItems > 0 ? 'flex' : 'none';
        };

        window.showCart = () => {
            let html = '<h2 style="margin-bottom:1.5rem; font-weight:400;">Your Cart</h2>';
            if (cart.length === 0) {
                html += '<div style="padding:3rem 0; text-align:center; color:#888;">Your cart is empty</div>';
            } else {
                cart.forEach((item, i) => {
                    html += `
                        <div class="cart-item">
                            <div>
                                <div style="font-weight:500;">${item.name}</div>
                                <div style="font-size:0.85rem; color:#666;">$${item.price.toFixed(2)} x ${item.qty}</div>
                            </div>
                            <button style="background:none; border:none; color:#e74c3c; cursor:pointer;" onclick="removeItem(${i})">Remove</button>
                        </div>`;
                });
                const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                html += `
                    <div style="margin:2rem 0; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:1.2rem;">Total:</span>
                        <span style="font-size:1.4rem; font-weight:600;">$${total.toFixed(2)}</span>
                    </div>
                    <button class="btn-primary" onclick="showCheckout()">Proceed to Checkout</button>`;
            }
            html += '<button class="btn-secondary" onclick="closeModal()">Close</button>';
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('cartModal').style.display = 'block';
        };

        window.showCheckout = () => {
            document.getElementById('modalContent').innerHTML = `
                <h2 style="margin-bottom:1.5rem; font-weight:400;">Checkout</h2>
                <div style="margin-bottom:1.5rem;">
                    <input id="cName" placeholder="Full Name">
                    <input id="cEmail" placeholder="Email Address">
                    <input id="cAddress" placeholder="Shipping Address">
                </div>
                <button class="btn-primary" onclick="placeOrder()">Place Order</button>
                <button class="btn-secondary" onclick="showCart()">Back to Cart</button>
            `;
        };

        // NEW: Place Order with JSON "total" field and Custom Success Screen
        window.placeOrder = async () => {
            const name = document.getElementById('cName').value;
            const email = document.getElementById('cEmail').value;
            const address = document.getElementById('cAddress').value;
            
            if(!name || !email || !address) return alert('Please fill all fields');

            // Calculate order total for the new JSON structure
            const orderTotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

            const order = { 
                customer: { name, email, address }, 
                items: cart, 
                time: Date.now(),
                total: orderTotal 
            };

            try {
                // 1. Save order to Firebase
                await set(push(ref(db, 'orders')), order);
                
                // 2. Update product stock levels
                for (let item of cart) {
                    const productRef = ref(db, `products/${item.id}`);
                    await update(productRef, { stock: item.max - item.qty });
                }

                // 3. Clear local cart
                cart = [];
                updateCartUI();
                
                // 4. Show the custom success screen
                showSuccessScreen();

            } catch (error) {
                console.error("Order error:", error);
                alert("There was an error processing your order. Please try again.");
            }
        };

        // NEW: Custom Success Screen implementation
        window.showSuccessScreen = () => {
            document.getElementById('modalContent').innerHTML = `
                <div class="success-container">
                    <div class="success-icon">✓</div>
                    <h2 class="success-title">Thank you. Your order has been received.</h2>
                    
                    <div class="payment-box">
                        <p>? For payment, we will contact you on WhatsApp.</p>
                    </div>

                    <p style="color:#666; margin-bottom:2rem; font-size:0.9rem;">
                        We have received your details and are preparing your items.
                    </p>
                    
                    <button class="btn-primary" onclick="closeModal()">Back to Shop</button>
                </div>
            `;
        };

        window.removeItem = (i) => { cart.splice(i, 1); updateCartUI(); showCart(); };
        window.closeModal = () => document.getElementById('cartModal').style.display = 'none';

        updateCartUI();
    </script>

    <script>
        // Parallax Effect for Hero Background
        window.addEventListener("scroll", () => {
            const y = window.scrollY;
            const bg = document.querySelector(".hero-lottie");
            if (bg) {
                bg.style.transform = `translateY(${y * 0.25}px)`;
            }
        });
    </script>
</body>
</html>