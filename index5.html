<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handmade Crochet Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #8b5cf6; --bg: #fafafa; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }
        body { background: var(--bg); }
        
        header { background: white; padding: 1rem 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-container { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .cart-btn { background: var(--primary); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; border: none; }

        .hero { text-align: center; padding: 4rem 1rem; background: #f3f0ff; border-bottom-left-radius: 50px; border-bottom-right-radius: 50px; }
        .container { max-width: 1100px; margin: 2rem auto; padding: 0 20px; }
        
        .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 2rem; }
        .product-card { background: white; border-radius: 20px; overflow: hidden; border: 1px solid #eee; transition: 0.3s; display: flex; flex-direction: column; }
        .img-container { height: 250px; background: #f3f4f6; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; }
        .p-info { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .price { font-size: 1.4rem; font-weight: 700; color: var(--primary); margin: 10px 0; }
        
        button { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background: white; max-width: 500px; margin: 1rem auto; padding: 2rem; border-radius: 25px; position: relative; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="businessName">Shop</div>
            <button class="cart-btn" onclick="showCart()">ðŸ›’ Cart (<span id="cartCount">0</span>)</button>
        </div>
    </header>

    <div class="hero">
        <h1 id="heroTitle">Loading...</h1>
        <p id="heroSubtitle">Please wait...</p>
    </div>

    <div class="container">
        <div class="products" id="productGrid"></div>
    </div>

    <div id="shopModal" class="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, push, set, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAfxtCHxeDz-RQR9vIk2FIORQLKtQ58uC8",
            authDomain: "by-artholic.firebaseapp.com",
            databaseURL: "https://by-artholic-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "by-artholic",
            storageBucket: "by-artholic.firebasestorage.app",
            messagingSenderId: "1082906393096",
            appId: "1:1082906393096:web:d5a7ab883fc432e624afbd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');

        // Sync Content
        onValue(ref(db, 'settings'), s => {
            const d = s.val() || {};
            document.getElementById('businessName').innerText = d.name || 'Crochet Shop';
            document.getElementById('heroTitle').innerText = d.title || 'Handmade Crochet';
            document.getElementById('heroSubtitle').innerText = d.subtitle || 'Made with love';
        });

        onValue(ref(db, 'products'), s => {
            const data = s.val();
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            for (let id in data) {
                const p = data[id];
                grid.innerHTML += `
                    <div class="product-card">
                        <div class="img-container">
                            <img src="${p.image || 'https://via.placeholder.com/400'}" alt="${p.name}">
                        </div>
                        <div class="p-info">
                            <h3>${p.name}</h3>
                            <div class="price">$${p.price.toFixed(2)}</div>
                            <p style="font-size:0.8rem; color:#666; margin-bottom:1rem">Stock: ${p.stock}</p>
                            <button onclick="addToCart('${id}', '${p.name}', ${p.price}, ${p.stock})" ${p.stock <= 0 ? 'disabled' : ''}>
                                ${p.stock > 0 ? 'Add to Cart' : 'Sold Out'}
                            </button>
                        </div>
                    </div>`;
            }
        });

        window.addToCart = (id, name, price, stock) => {
            const item = cart.find(i => i.id === id);
            if(item) {
                if(item.qty < stock) item.qty++;
                else return alert("Max stock reached");
            } else {
                cart.push({id, name, price, qty: 1, max: stock});
            }
            updateUI();
        };

        function updateUI() {
            localStorage.setItem('cart', JSON.stringify(cart));
            document.getElementById('cartCount').innerText = cart.reduce((a,b) => a + b.qty, 0);
        }

        window.showCart = () => {
            let html = `<h2>Your Cart</h2><br>`;
            if(cart.length === 0) html += "<p>Empty</p>";
            else {
                cart.forEach((item, i) => {
                    html += `<div class="cart-item">
                        <div><b>${item.name}</b><br>$${item.price} x ${item.qty}</div>
                        <button onclick="removeItem(${i})" style="width:auto; padding:5px 10px; background:#ef4444">Remove</button>
                    </div>`;
                });
                html += `<button onclick="showCheckout()">Proceed to Checkout</button>`;
            }
            html += `<button onclick="closeModal()" style="background:#666; margin-top:10px">Continue Shopping</button>`;
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('shopModal').style.display = 'block';
        };

        window.showCheckout = () => {
            const total = cart.reduce((a,b) => a + (b.price * b.qty), 0);
            document.getElementById('modalContent').innerHTML = `
                <h2>Checkout</h2>
                <p>Total: <b>$${total.toFixed(2)}</b></p>
                <input id="cName" placeholder="Your Name" required>
                <input id="cEmail" placeholder="Email Address" required>
                <input id="cAddress" placeholder="Full Delivery Address" required>
                <button onclick="placeOrder()">Confirm Order</button>
                <button onclick="showCart()" style="background:#666; margin-top:10px">Back to Cart</button>
            `;
        };

        window.placeOrder = async () => {
            const name = document.getElementById('cName').value;
            const email = document.getElementById('cEmail').value;
            if(!name || !email) return alert("Fill details");

            const order = {
                customer: { name, email, address: document.getElementById('cAddress').value },
                items: cart,
                total: cart.reduce((a,b) => a + (b.price * b.qty), 0),
                time: Date.now()
            };

            const orderRef = push(ref(db, 'orders'));
            await set(orderRef, order);
            
            // Deduct Stock
            for(let item of cart) {
                update(ref(db, `products/${item.id}`), { stock: item.max - item.qty });
            }

            cart = [];
            updateUI();
            document.getElementById('modalContent').innerHTML = `<h2>Success!</h2><p>Order #${orderRef.key.slice(-5)} placed.</p><button onclick="closeModal()">Close</button>`;
        };

        window.removeItem = (i) => { cart.splice(i, 1); updateUI(); showCart(); };
        window.closeModal = () => document.getElementById('shopModal').style.display = 'none';
        updateUI();
    </script>
</body>
</html>